name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to upload to (e.g., v0.1.0)'
        required: true
        type: string

env:
  ZIG_VERSION: "0.15.2"

jobs:
  build-release:
    name: Build ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Tier 1 - Primary Targets
          - target: x86_64-linux-gnu
            ext: tar.gz
          - target: x86_64-linux-musl
            ext: tar.gz
          - target: aarch64-linux-gnu
            ext: tar.gz
          - target: aarch64-linux-musl
            ext: tar.gz
          - target: x86_64-windows
            ext: zip
          # Tier 2 - Extended Reach
          - target: aarch64-windows
            ext: zip
          - target: x86_64-freebsd
            ext: tar.gz
          - target: aarch64-freebsd
            ext: tar.gz


    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Build Release
        run: zig build -Doptimize=ReleaseFast -Dtarget=${{ matrix.target }} -Dserver=true

      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Archive Directory
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARCHIVE_NAME="igllama-${VERSION}-${{ matrix.target }}"
          mkdir -p "${ARCHIVE_NAME}"
          
          # Copy binaries (handle Windows .exe)
          if [[ "${{ matrix.target }}" == *windows* ]]; then
            cp zig-out/bin/igllama.exe "${ARCHIVE_NAME}/"
            cp zig-out/bin/llama-server.exe "${ARCHIVE_NAME}/"
          else
            cp zig-out/bin/igllama "${ARCHIVE_NAME}/"
            cp zig-out/bin/llama-server "${ARCHIVE_NAME}/"
          fi
          
          # Copy docs
          cp LICENSE README.md "${ARCHIVE_NAME}/"
          
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Create Archive (tar.gz)
        if: matrix.ext == 'tar.gz'
        run: |
          tar -czvf "${ARCHIVE_NAME}.${{ matrix.ext }}" "${ARCHIVE_NAME}"

      - name: Create Archive (zip)
        if: matrix.ext == 'zip'
        run: |
          zip -r "${ARCHIVE_NAME}.${{ matrix.ext }}" "${ARCHIVE_NAME}"

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          gh release upload "${VERSION}" "${ARCHIVE_NAME}.${{ matrix.ext }}" --clobber

  # macOS builds with Metal GPU support (requires native runner)
  # Using native runners and NOT specifying -Dtarget to ensure frameworks are found
  build-macos-metal:
    name: Build ${{ matrix.name }}-metal
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Intel Mac runner for x86_64 (macos-13 retired, using macos-15-intel)
          - runner: macos-15-intel
            name: x86_64-macos
            arch: x86_64
          # ARM Mac runner for aarch64
          - runner: macos-latest
            name: aarch64-macos
            arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Explicit submodule init to work around macOS runner checkout issues
      - name: Ensure Submodules
        run: |
          git submodule update --init --recursive

      - name: Verify Submodule Files
        run: |
          # Verify critical submodule files exist (file structure changed in recent llama.cpp)
          ls -la llama.cpp/ggml/src/ggml-metal/ggml-metal.cpp
          ls -la llama.cpp/ggml/src/ggml-metal/ggml-metal.metal

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      # Build WITHOUT -Dtarget to use native target and find frameworks properly
      - name: Build Release with Metal
        run: zig build -Doptimize=ReleaseFast -Dserver=true -Dmetal=true

      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Archive Directory
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARCHIVE_NAME="igllama-${VERSION}-${{ matrix.name }}-metal"
          mkdir -p "${ARCHIVE_NAME}"
          
          cp zig-out/bin/igllama "${ARCHIVE_NAME}/"
          cp zig-out/bin/llama-server "${ARCHIVE_NAME}/"
          
          # Copy Metal shader library if present
          if [ -f zig-out/bin/default.metallib ]; then
            cp zig-out/bin/default.metallib "${ARCHIVE_NAME}/"
            cp zig-out/bin/ggml-metal.metal "${ARCHIVE_NAME}/" 2>/dev/null || true
          fi
          
          cp LICENSE README.md "${ARCHIVE_NAME}/"
          
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Create Archive
        run: |
          tar -czvf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          gh release upload "${VERSION}" "${ARCHIVE_NAME}.tar.gz" --clobber

  # Also build CPU-only macOS versions (cross-compiled from Linux for consistency)
  build-macos-cpu:
    name: Build ${{ matrix.target }} (CPU)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-macos
          - target: aarch64-macos

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Build Release
        run: zig build -Doptimize=ReleaseFast -Dtarget=${{ matrix.target }} -Dserver=true

      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Archive Directory
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARCHIVE_NAME="igllama-${VERSION}-${{ matrix.target }}"
          mkdir -p "${ARCHIVE_NAME}"
          
          cp zig-out/bin/igllama "${ARCHIVE_NAME}/"
          cp zig-out/bin/llama-server "${ARCHIVE_NAME}/"
          cp LICENSE README.md "${ARCHIVE_NAME}/"
          
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Create Archive
        run: |
          tar -czvf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          gh release upload "${VERSION}" "${ARCHIVE_NAME}.tar.gz" --clobber

  # Create source tarball with submodules for use in zon dependencies
  create-source-tarball:
    name: Create Source Tarball
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Create tarball including submodule
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DIR=project-${VERSION}
          
          mkdir $DIR
          cp -R . $DIR
          rm -rf $DIR/.git
          rm -rf $DIR/.github
          
          tar -czf ${DIR}.tar.gz $DIR

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          gh release upload "${VERSION}" project-${VERSION}.tar.gz --clobber

  # Create checksums after all builds complete
  checksums:
    name: Generate Checksums
    runs-on: ubuntu-latest
    needs: [build-release, build-macos-metal, build-macos-cpu, create-source-tarball]
    steps:
      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Download Release Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          gh release download "${VERSION}" --repo ${{ github.repository }} --dir assets

      - name: Generate SHA256 Checksums
        run: |
          cd assets
          sha256sum * > checksums-sha256.txt
          cat checksums-sha256.txt

      - name: Upload Checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          gh release upload "${VERSION}" assets/checksums-sha256.txt --clobber --repo ${{ github.repository }}
